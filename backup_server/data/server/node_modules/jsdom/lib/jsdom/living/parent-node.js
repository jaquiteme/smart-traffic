"use strict";

const defineGetter = require("jsdom/lib/jsdom/utils").defineGetter;
const domSymbolTree = require("jsdom/lib/jsdom/living/helpers/internal-constants").domSymbolTree;
const NODE_TYPE = require("jsdom/lib/jsdom/living/node-type");
const createHTMLCollection = require("jsdom/lib/jsdom/living/html-collection").create;
const updateHTMLCollection = require("jsdom/lib/jsdom/living/html-collection").update;

module.exports = function (core) {
  // https://dom.spec.whatwg.org/#interface-parentnode
  // Note that ParentNode is a "NoInterfaceObject"

  const implementers = [core.Document, core.DocumentFragment, core.Element];

  implementers.forEach(function (Constructor) {
    defineGetter(Constructor.prototype, "children", function () {
      if (!this._childrenList) {
        const self = this;
        this._childrenList = createHTMLCollection(this, function () {
          return domSymbolTree.childrenToArray(self, {filter: function (node) {
            return node.nodeType === NODE_TYPE.ELEMENT_NODE;
          }});
        });
      } else {
        updateHTMLCollection(this._childrenList);
      }
      return this._childrenList;
    });

    defineGetter(Constructor.prototype, "firstElementChild", function () {
      for (const child of domSymbolTree.childrenIterator(this)) {
        if (child.nodeType === NODE_TYPE.ELEMENT_NODE) {
          return child;
        }
      }

      return null;
    });

    defineGetter(Constructor.prototype, "lastElementChild", function () {
      for (const child of domSymbolTree.childrenIterator(this, {reverse: true})) {
        if (child.nodeType === NODE_TYPE.ELEMENT_NODE) {
          return child;
        }
      }

      return null;
    });

    defineGetter(Constructor.prototype, "childElementCount", function () {
      return this.children.length;
    });
  });
};
